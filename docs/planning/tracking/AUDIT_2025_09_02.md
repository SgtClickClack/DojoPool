### 2025-09-02: Strategic Codebase Audit (Architecture, Quality, Performance, Roadmap)

**Scope:** Monorepo-wide review across `apps/web` (Next.js), `services/api` (NestJS), and `packages/*` (Prisma, types, utils).

#### Summary of Significant Findings

- **Backend/data mismatch:** `packages/prisma/schema.prisma` uses `sqlite` provider; project targets Postgres at scale. This is the top risk for scalability and correctness (indexing, JSONB, concurrency).
- **Schema quality debt:** Multiple duplicate/ambiguous fields and stringified JSON in models (e.g., `Notification.read` vs `isRead`, `Achievement.desc` vs `description`, `VenueQuest.active` vs `isActive`, `Content.metadata/tags` as `String`).
- **Caching and realtime are well-structured:** Production-gated Redis adapter, helmet, rate limits, unified CORS, namespaced Socket.IO, feature-flag gating. Good production posture.
- **Frontend API layer is centralized:** `apps/web/src/services/APIService.ts` aligns with rewrites in `next.config.js`. Some endpoints rely on rewrite behavior (`/cms/...`) rather than explicit `/v1/...`, which is acceptable but should be documented.
- **Testing and tooling are present:** Vitest unit/integration configs with coverage scripts, Cypress e2e, ESLint flat config. Coverage level not verified repo-wide.
- **Docs and tracking are mature:** Roadmaps and tracking files are comprehensive; alignment largely consistent with current code.

#### Weaknesses & Actionable Areas (Checklist)

- [ ] Switch Prisma datasource to Postgres and run proper migrations
  - Update `schema.prisma` provider to `postgresql`; configure `DATABASE_URL`;
  - Add required indexes (unique/compound, GIN for JSONB where needed).
- [ ] Replace stringified JSON with `Json` types where appropriate
  - `Content.metadata`, `Content.tags`, `CommunityCosmeticItem.metadata/tags`, others.
- [ ] Remove duplicate/ambiguous fields
  - `Notification.read` vs `isRead` (choose one);
  - `Achievement.desc` vs `description` (keep `description`);
  - `VenueQuest.active` vs `isActive` (keep one consistent flag).
- [ ] Validate relational constraints for intent
  - `ClanMember.userId @unique` enforces single-clan membership; if intended, remove redundant `@@unique([clanId, userId])`. If not intended, remove `@unique` on `userId` and keep compound unique.
  - Friendship uniqueness should consider symmetric relationships; add guard or normalized ordering.
- [ ] Add DB-level indexes for scale paths
  - High-traffic lookups: `User.email`, `Content.userId`, `Territory.venueId`, `Tournament.status`, `Notification.userId`.
- [ ] Align environment and migrations across dev/test/prod
  - Ensure CI spins Postgres; migrate test harnesses off sqlite; add `prisma migrate deploy` in CI.
- [ ] WebSocket production posture
  - Confirm Redis adapter is strictly enforced (already guarded); add health probes and backpressure metrics.
- [ ] API routing consistency
  - Keep all client calls under `/api/*` with Next rewrite to `/api/v1/*`; document CMS routes expectations; forbid bare `http://` in client.
- [ ] Coverage verification gate
  - Enforce 80% coverage per workspace; publish coverage summary; ensure e2e smoke covers world-map/tournaments/venues.
- [ ] Performance/load testing
  - Add k6 scenarios for tournaments list, content feed, notifications, and socket fanout.

#### Strategic Recommendations (Prioritized)

1. **Migrate Prisma to Postgres (Critical, Week 1)**
   - Change provider, add indices, convert string-JSON to `Json`, reconcile duplicates, run zero-downtime migration plan.
2. **Schema hygiene pass (High, Week 1–2)**
   - Remove duplicate columns, fix constraints (ClanMember, Friendship), add missing FKs/cascades where safe.
3. **DB performance foundations (High, Week 2)**
   - Add read-optimized indexes; implement JSONB GIN indexes for search/filter fields; baseline query plans.
4. **Test/CI hardening (High, Week 2)**
   - Postgres-backed tests; enforce 80% coverage gates; add migrate/seed in CI; smoke e2e (Cypress) on PR.
5. **Realtime scale posture (Med, Week 3)**
   - Socket payload trimming, event batching where applicable; add redis/WS health metrics; chaos/restart drills.
6. **Caching policy review (Med, Week 3)**
   - Verify TTLs by domain (notifications short, tournaments medium, marketplace medium); ensure write-through invalidation patterns in hot paths.
7. **UX consistency and doc updates (Med, ongoing)**
   - Document API routing contract (`/api → /api/v1`), CMS endpoints, and feature flags; ensure frontend imports remain centralized via `APIService.ts`.

---

**Core Components Reviewed:**

- Backend NestJS (`services/api`): bootstrap, CORS, feature flags, gateways, cache, monitoring
- Frontend Next.js (`apps/web`): `next.config.js`, services (`APIService.ts`), pages and components
- Data (`packages/prisma`): `schema.prisma` models and relations
- Tooling: ESLint, Vitest, Cypress, CI scripts, rate-limit/helmet, rewrites/headers

**File Paths (sampling):**

- `services/api/src/main.ts`, `services/api/src/app.module.ts`
- `services/api/src/world-map/world-map.gateway.ts`
- `services/api/src/cache/cache.service.ts`
- `services/api/src/config/{cors.config.ts,feature-flags.config.ts,sockets.config.ts}`
- `apps/web/next.config.js`, `apps/web/src/services/APIService.ts`
- `packages/prisma/schema.prisma`

**Next Priority Task:**

- Execute Postgres migration plan: switch provider, convert string-JSON to `Json`, add indexes, remove duplicate columns, and run `prisma migrate` for dev/test/CI.

Expected completion time: 3–5 days (with verification and backfill scripts)
