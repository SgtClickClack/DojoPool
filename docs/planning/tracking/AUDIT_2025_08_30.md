# 2025-08-30: Strategic Codebase Audit

Comprehensive architecture, code quality, and performance audit across the monorepo. Focused on long-term scalability, maintainability, and feature velocity alignment with the MVP and phase roadmap.

**Core Components Implemented:**

- Architectural review: monorepo layout, app/services boundaries, data flow, realtime, and SPOFs
- Code quality review: patterns, naming, duplication, tests, and docs currency
- Performance review: caching strategy, DB scaling, Socket.IO readiness, env validation
- Roadmap review: UX gaps across tournaments, venues, social, and map flows; debt and refactor priorities

**File Paths:**

- `package.json` (workspaces, scripts, tooling)
- `apps/web/next.config.js`, `next.config.js` (rewrites, security headers, duplication)
- `apps/web/tsconfig.json` (path aliases)
- `apps/web/src/services/APIService.ts`, `apps/web/src/services/apiClient.ts`, `apps/web/src/services/dojoService.ts` (API layer duplication/inconsistency)
- `services/api/src/main.ts`, `services/api/src/app.module.ts` (bootstrap, CORS, global prefix)
- `services/api/src/config/{cors.config.ts,sockets.config.ts,env.validation.ts,feature-flags.config.ts}` (centralization, validation)
- `services/api/src/{redis,cache}/**` (Redis adapter, caching facilities, decorators)
- `services/api/src/world-map/world-map.gateway.ts` (realtime world state)
- `packages/prisma/schema.prisma` (schema scale and JSON-heavy fields)
- `vitest.unit.config.ts`, `vitest.integration.config.ts` (coverage thresholds, includes/excludes)
- `docs/planning/roadmap.md`, `docs/planning/tracking/part-03.md` (alignment)

**Next Priority Task:**
Consolidate the frontend API layer: migrate all inline `fetch` and duplicate clients to a single typed `APIService` (axios-based) under `apps/web/src/services/`, remove `dojoService.ts` http calls and unify on `/api/v1` via Next rewrites. Add missing typed functions and tests.

Expected completion time: 4 hours

## Significant Findings (Summary)

- Monorepo structure is sound (Turbo + workspaces) but contains duplicates: nested `apps/web/apps/web/...` and `services/api/apps/web/...` artifacts.
- Mixed Next.js configs and versions: root `next.config.js` (ESM) vs `apps/web/next.config.js` (CJS); Next 15 in root vs 14 in app.
- Frontend API layer is duplicated (`APIService.ts` and `apiClient.ts`) with inconsistent base URLs and auth handling.
- Backend WebSocket Redis adapter usage likely incorrect; namespaces/ports inconsistent with frontend default `http://localhost:8080`.
- Prisma schema is robust but JSON-heavy and lacks explicit indexes on high-cardinality FKs; SQLite artifacts present alongside Postgres.
- Security risks: hardcoded Google OAuth secrets in `services/api/src/auth/auth.service.ts`; JWTs stored in `localStorage` in web.
- Caching uses Redis only in prod and relies on `KEYS` pattern deletions; no Prometheus/OpenTelemetry wiring despite deps.
- Tooling drift: root scripts use npm while workspace declares `yarn@4`; Jest in app vs Vitest in repo; duplicate security headers (Next middleware and config).

## Weaknesses Checklist (Actionable)

- Remove hardcoded OAuth secrets; enforce env validation on boot (fail fast in prod).
- Consolidate API clients to single `APIService` and remove `apiClient.ts` HTTP usage.
- Unify WebSocket URL/namespaces; fix Redis adapter to use `createAdapter(pub, sub)`; align ports (3002) and env-driven URLs.
- Deduplicate Next configs; keep `apps/web/next.config.js`; remove or document root config; align Next to a single major version.
- Migrate JWT storage from `localStorage` to HttpOnly cookies or integrate Auth.js where feasible.
- Replace Redis `KEYS` usage with `SCAN` or tag sets; avoid O(N) invalidation.
- Add Prisma indexes on common query paths (e.g., `User.email`, foreign keys for `Match`, `ActivityEvent`, `Notification`).
- Purge `mongoose` and unused session middleware (`express-session`, `connect-redis`) from web; keep session concerns server-side.
- Remove SQLite artifacts (`dev.db`) from `services/api/prisma` and `packages/prisma`; standardize on Postgres via `DATABASE_URL`.
- Standardize on Yarn v4 scripts; replace root `npm run ...` usages with `yarn`.
- Unify testing on Vitest (or Jest) across workspaces; ensure 80% coverage gates apply consistently.
- Add `/metrics` using `prom-client` in Nest; consider OpenTelemetry export; keep `HealthController` for liveness.

## Strategic Recommendations (Prioritized)

1. Consolidate frontend API layer to a single typed `APIService` and update all callers; enforce `/api/v1` via rewrites; add tests.
2. Remove hardcoded secrets; add strict config validation in `AppModule`/bootstrap; document required env vars.
3. Fix realtime: correct Redis adapter usage, centralize Socket.IO namespaces and URLs; align client/server ports; add health probes.
4. Database hardening: remove SQLite and `mongoose`, add Prisma indexes and query limits on JSON-heavy tables; plan partitioning for events.
5. Caching improvements: replace `KEYS` with `SCAN`/tagging; add cache hit/miss metrics; set consistent TTLs per domain.
6. Workspace hygiene: dedupe Next configs, align to single Next version; convert root scripts to Yarn; remove duplicate app folders.
7. Observability: expose Prometheus metrics, wire basic OpenTelemetry; add /ready probe and rate limiting at ingress.
8. Security posture: migrate auth tokens to cookies or Auth.js; reconcile CSP between middleware and headers; document CORS origins.
9. Testing alignment: unify on Vitest (or Jest) with shared setup; maintain coverage thresholds; add WS and cache integration tests.
