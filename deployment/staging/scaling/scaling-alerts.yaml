groups:
  - name: dojopool.scaling.alerts
    rules:
      # HPA Scale Up Alerts
      - alert: HighPodCPUUsage
        expr: rate(container_cpu_usage_seconds_total{pod=~".*", namespace="staging"}[5m]) > 0.8
        for: 2m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: 'High CPU usage detected on pod {{ $labels.pod }}'
          description: 'Pod {{ $labels.pod }} is using {{ $value | printf "%.2f" }} CPU cores (80% threshold)'
          runbook_url: 'https://dojopool.com/runbooks/high-cpu-usage'

      - alert: HighPodMemoryUsage
        expr: (container_memory_usage_bytes{pod=~".*", namespace="staging"} / container_spec_memory_limit_bytes) > 0.85
        for: 2m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: 'High memory usage detected on pod {{ $labels.pod }}'
          description: 'Pod {{ $labels.pod }} is using {{ $value | printf "%.1f" }}% of memory limit'
          runbook_url: 'https://dojopool.com/runbooks/high-memory-usage'

      # Database Connection Pool Alerts
      - alert: DatabaseConnectionPoolExhaustion
        expr: pgbouncer_pools_client_active_connections / pgbouncer_pools_client_maxwait_seconds > 0.8
        for: 1m
        labels:
          severity: critical
          team: database
        annotations:
          summary: 'Database connection pool nearly exhausted'
          description: 'PgBouncer connection pool is {{ $value | printf "%.1f" }}% full'
          runbook_url: 'https://dojopool.com/runbooks/db-connection-pool'

      - alert: DatabaseReplicaLag
        expr: pg_replication_lag > 30
        for: 2m
        labels:
          severity: warning
          team: database
        annotations:
          summary: 'Database replica lag is high'
          description: 'PostgreSQL replica lag is {{ $value }} seconds'
          runbook_url: 'https://dojopool.com/runbooks/replica-lag'

      # API Performance Alerts
      - alert: HighAPIResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="dojopool-api"}[5m])) > 1.0
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'API response time is high'
          description: '95th percentile API response time is {{ $value }}s'
          runbook_url: 'https://dojopool.com/runbooks/high-api-latency'

      - alert: HighAPIErrorRate
        expr: rate(http_requests_total{job="dojopool-api", status=~"5.."}[5m]) / rate(http_requests_total{job="dojopool-api"}[5m]) > 0.05
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'High API error rate detected'
          description: 'API error rate is {{ $value | printf "%.1f" }}%'
          runbook_url: 'https://dojopool.com/runbooks/api-errors'

      # Tournament Service Alerts
      - alert: TournamentServiceOverload
        expr: rate(tournament_requests_total[5m]) > 100
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Tournament service is overloaded'
          description: 'Tournament service is handling {{ $value }} requests/second'
          runbook_url: 'https://dojopool.com/runbooks/tournament-overload'

      # WebSocket Connection Alerts
      - alert: HighWebSocketConnectionCount
        expr: websocket_active_connections > 5000
        for: 3m
        labels:
          severity: warning
          team: frontend
        annotations:
          summary: 'High number of WebSocket connections'
          description: 'Active WebSocket connections: {{ $value }}'
          runbook_url: 'https://dojopool.com/runbooks/websocket-connections'

      # Queue Backlog Alerts
      - alert: HighQueueBacklog
        expr: message_queue_length > 1000
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Message queue backlog is high'
          description: 'Queue length: {{ $value }} messages'
          runbook_url: 'https://dojopool.com/runbooks/queue-backlog'

      # Scaling Event Alerts
      - alert: HPAScalingEvent
        expr: kube_hpa_status_current_replicas{namespace="staging"} / kube_hpa_spec_max_replicas > 0.8
        for: 5m
        labels:
          severity: info
          team: platform
        annotations:
          summary: 'HPA is scaling near maximum capacity'
          description: 'HPA {{ $labels.horizontalpodautoscaler }} is at {{ $value | printf "%.1f" }}% of max replicas'
          runbook_url: 'https://dojopool.com/runbooks/hpa-scaling'

      # Cost Optimization Alerts
      - alert: HighInfrastructureCost
        expr: increase(aws_costs_total[1h]) > 100
        for: 10m
        labels:
          severity: info
          team: finance
        annotations:
          summary: 'Infrastructure costs are increasing rapidly'
          description: 'Hourly cost increase: ${{ $value | printf "%.2f" }}'
          runbook_url: 'https://dojopool.com/runbooks/cost-optimization'

      # Performance Degradation Alerts
      - alert: DatabaseQuerySlowdown
        expr: histogram_quantile(0.95, rate(postgres_query_duration_seconds[5m])) > 2.0
        for: 3m
        labels:
          severity: warning
          team: database
        annotations:
          summary: 'Database query performance degraded'
          description: '95th percentile query time: {{ $value }}s'
          runbook_url: 'https://dojopool.com/runbooks/db-performance'

      - alert: CacheMissRateIncrease
        expr: rate(redis_keyspace_misses_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) > 0.15
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Cache miss rate is high'
          description: 'Redis cache miss rate: {{ $value | printf "%.1f" }}%'
          runbook_url: 'https://dojopool.com/runbooks/cache-performance'

      # User Experience Alerts
      - alert: HighUserErrorRate
        expr: rate(user_error_events_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          team: product
        annotations:
          summary: 'High rate of user-facing errors'
          description: 'User error rate: {{ $value }} errors/minute'
          runbook_url: 'https://dojopool.com/runbooks/user-experience'

      - alert: TournamentJoinFailures
        expr: rate(tournament_join_failures_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Tournament join failures increasing'
          description: 'Tournament join failure rate: {{ $value }} failures/minute'
          runbook_url: 'https://dojopool.com/runbooks/tournament-joins'
