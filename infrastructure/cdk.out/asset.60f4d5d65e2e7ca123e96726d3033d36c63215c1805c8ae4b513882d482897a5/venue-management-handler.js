'use strict';
Object.defineProperty(exports, '__esModule', { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require('@aws-sdk/client-dynamodb');
const lib_dynamodb_1 = require('@aws-sdk/lib-dynamodb');
const dynamoClient = new client_dynamodb_1.DynamoDBClient({
  region: 'ap-southeast-2',
});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const VENUES_TABLE = process.env.VENUES_TABLE;
const USERS_TABLE = process.env.USERS_TABLE;
const GAME_SESSIONS_TABLE = process.env.GAME_SESSIONS_TABLE;
const TOURNAMENTS_TABLE = process.env.TOURNAMENTS_TABLE;
const ANALYTICS_TABLE = process.env.ANALYTICS_TABLE;
const handler = async (event) => {
  try {
    const { httpMethod, path, pathParameters, body } = event;
    console.log(`Processing ${httpMethod} request to ${path}`);
    // CORS headers
    const headers = {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'Content-Type,Authorization',
      'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',
    };
    // Handle OPTIONS requests for CORS
    if (httpMethod === 'OPTIONS') {
      return {
        statusCode: 200,
        headers,
        body: '',
      };
    }
    // Route handling
    if (path === '/venues' && httpMethod === 'GET') {
      return await listVenues();
    } else if (path === '/venues' && httpMethod === 'POST') {
      return await createVenue(body);
    } else if (pathParameters?.venueId && httpMethod === 'GET') {
      return await getVenue(pathParameters.venueId);
    } else if (pathParameters?.venueId && httpMethod === 'PUT') {
      return await updateVenue(pathParameters.venueId, body);
    } else if (pathParameters?.venueId && httpMethod === 'DELETE') {
      return await deleteVenue(pathParameters.venueId);
    } else if (path.includes('/analytics') && httpMethod === 'GET') {
      const venueId = pathParameters?.venueId;
      return await getVenueAnalytics(venueId);
    } else if (path.includes('/tournaments') && httpMethod === 'GET') {
      const venueId = pathParameters?.venueId;
      return await listVenueTournaments(venueId);
    } else if (path.includes('/tournaments') && httpMethod === 'POST') {
      const venueId = pathParameters?.venueId;
      return await createTournament(venueId, body);
    }
    return {
      statusCode: 404,
      headers,
      body: JSON.stringify({ error: 'Not Found' }),
    };
  } catch (error) {
    console.error('Error:', error);
    return {
      statusCode: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({ error: 'Internal Server Error' }),
    };
  }
};
exports.handler = handler;
async function listVenues() {
  const command = new lib_dynamodb_1.QueryCommand({
    TableName: VENUES_TABLE,
    IndexName: 'LocationIndex',
    KeyConditionExpression: 'city = :city',
    ExpressionAttributeValues: {
      ':city': 'Sydney', // Default to Sydney for now
    },
  });
  const result = await docClient.send(command);
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({
      venues: result.Items || [],
    }),
  };
}
async function createVenue(body) {
  if (!body) {
    return {
      statusCode: 400,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({ error: 'Request body is required' }),
    };
  }
  const venueData = JSON.parse(body);
  const venueId = `venue_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const venue = {
    venueId,
    venueName: venueData.venueName,
    address: venueData.address,
    city: venueData.city || 'Sydney',
    state: venueData.state || 'NSW',
    country: venueData.country || 'Australia',
    phone: venueData.phone,
    email: venueData.email,
    website: venueData.website,
    description: venueData.description,
    capacity: venueData.capacity,
    poolTables: venueData.poolTables || 1,
    amenities: venueData.amenities || [],
    operatingHours: venueData.operatingHours,
    ownerId: venueData.ownerId,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    status: 'active',
  };
  const command = new lib_dynamodb_1.PutCommand({
    TableName: VENUES_TABLE,
    Item: venue,
  });
  await docClient.send(command);
  return {
    statusCode: 201,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({ venue }),
  };
}
async function getVenue(venueId) {
  const command = new lib_dynamodb_1.GetCommand({
    TableName: VENUES_TABLE,
    Key: { venueId },
  });
  const result = await docClient.send(command);
  if (!result.Item) {
    return {
      statusCode: 404,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({ error: 'Venue not found' }),
    };
  }
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({ venue: result.Item }),
  };
}
async function updateVenue(venueId, body) {
  if (!body) {
    return {
      statusCode: 400,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({ error: 'Request body is required' }),
    };
  }
  const updateData = JSON.parse(body);
  let updateExpression = 'SET updatedAt = :updatedAt';
  const expressionAttributeValues = {
    ':updatedAt': new Date().toISOString(),
  };
  // Build dynamic update expression
  Object.keys(updateData).forEach((key) => {
    if (key !== 'venueId' && key !== 'createdAt') {
      expressionAttributeValues[`:${key}`] = updateData[key];
      updateExpression += `, ${key} = :${key}`;
    }
  });
  const command = new lib_dynamodb_1.UpdateCommand({
    TableName: VENUES_TABLE,
    Key: { venueId },
    UpdateExpression: updateExpression,
    ExpressionAttributeValues: expressionAttributeValues,
    ReturnValues: 'ALL_NEW',
  });
  const result = await docClient.send(command);
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({ venue: result.Attributes }),
  };
}
async function deleteVenue(venueId) {
  const command = new lib_dynamodb_1.DeleteCommand({
    TableName: VENUES_TABLE,
    Key: { venueId },
  });
  await docClient.send(command);
  return {
    statusCode: 204,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: '',
  };
}
async function getVenueAnalytics(venueId) {
  const command = new lib_dynamodb_1.QueryCommand({
    TableName: ANALYTICS_TABLE,
    KeyConditionExpression: 'venueId = :venueId',
    ExpressionAttributeValues: {
      ':venueId': venueId,
    },
    ScanIndexForward: false,
    Limit: 30, // Last 30 days
  });
  const result = await docClient.send(command);
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({
      analytics: result.Items || [],
    }),
  };
}
async function listVenueTournaments(venueId) {
  const command = new lib_dynamodb_1.QueryCommand({
    TableName: TOURNAMENTS_TABLE,
    IndexName: 'VenueTournamentsIndex',
    KeyConditionExpression: 'venueId = :venueId',
    ExpressionAttributeValues: {
      ':venueId': venueId,
    },
    ScanIndexForward: false, // Most recent first
  });
  const result = await docClient.send(command);
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({
      tournaments: result.Items || [],
    }),
  };
}
async function createTournament(venueId, body) {
  if (!body) {
    return {
      statusCode: 400,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({ error: 'Request body is required' }),
    };
  }
  const tournamentData = JSON.parse(body);
  const tournamentId = `tournament_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const tournament = {
    tournamentId,
    venueId,
    tournamentName: tournamentData.tournamentName,
    description: tournamentData.description,
    startDate: tournamentData.startDate,
    endDate: tournamentData.endDate,
    entryFee: tournamentData.entryFee,
    prizePool: tournamentData.prizePool,
    maxParticipants: tournamentData.maxParticipants,
    currentParticipants: 0,
    status: 'upcoming',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };
  const command = new lib_dynamodb_1.PutCommand({
    TableName: TOURNAMENTS_TABLE,
    Item: tournament,
  });
  await docClient.send(command);
  return {
    statusCode: 201,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    },
    body: JSON.stringify({ tournament }),
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVudWUtbWFuYWdlbWVudC1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidmVudWUtbWFuYWdlbWVudC1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBbUk7QUFFbkksTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztBQUN0RSxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFNUQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFhLENBQUM7QUFDL0MsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFZLENBQUM7QUFDN0MsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQixDQUFDO0FBQzdELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBa0IsQ0FBQztBQUN6RCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWdCLENBQUM7QUFFOUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDM0YsSUFBSTtRQUNGLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFFekQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLFVBQVUsZUFBZSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTNELGVBQWU7UUFDZixNQUFNLE9BQU8sR0FBRztZQUNkLGNBQWMsRUFBRSxrQkFBa0I7WUFDbEMsNkJBQTZCLEVBQUUsR0FBRztZQUNsQyw4QkFBOEIsRUFBRSw0QkFBNEI7WUFDNUQsOEJBQThCLEVBQUUsNkJBQTZCO1NBQzlELENBQUM7UUFFRixtQ0FBbUM7UUFDbkMs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SUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7S0FDcEMsQ0FBQztJQUVGLE1BQU0sT0FBTyxHQUFHLElBQUkseUJBQVUsQ0FBQztRQUM3QixTQUFTLEVBQUUsaUJBQWlCO1FBQzVCLElBQUksRUFBRSxVQUFVO0tBQ2pCLENBQUMsQ0FBQztJQUVILE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUU5QixPQUFPO1FBQ0wsVUFBVSxFQUFFLEdBQUc7UUFDZixPQUFPLEVBQUU7WUFDUCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7U0FDbkM7UUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDO0tBQ3JDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIFB1dENvbW1hbmQsIFF1ZXJ5Q29tbWFuZCwgRGVsZXRlQ29tbWFuZCwgVXBkYXRlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XHJcblxyXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246ICdhcC1zb3V0aGVhc3QtMicgfSk7XHJcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xyXG5cclxuY29uc3QgVkVOVUVTX1RBQkxFID0gcHJvY2Vzcy5lbnYuVkVOVUVTX1RBQkxFITtcclxuY29uc3QgVVNFUlNfVEFCTEUgPSBwcm9jZXNzLmVudi5VU0VSU19UQUJMRSE7XHJcbmNvbnN0IEdBTUVfU0VTU0lPTlNfVEFCTEUgPSBwcm9jZXNzLmVudi5HQU1FX1NFU1NJT05TX1RBQkxFITtcclxuY29uc3QgVE9VUk5BTUVOVFNfVEFCTEUgPSBwcm9jZXNzLmVudi5UT1VSTkFNRU5UU19UQUJMRSE7XHJcbmNvbnN0IEFOQUxZVElDU19UQUJMRSA9IHByb2Nlc3MuZW52LkFOQUxZVElDU19UQUJMRSE7XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGh0dHBNZXRob2QsIHBhdGgsIHBhdGhQYXJhbWV0ZXJzLCBib2R5IH0gPSBldmVudDtcclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgJHtodHRwTWV0aG9kfSByZXF1ZXN0IHRvICR7cGF0aH1gKTtcclxuXHJcbiAgICAvLyBDT1JTIGhlYWRlcnNcclxuICAgIGNvbnN0IGhlYWRlcnMgPSB7XHJcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnR0VULFBPU1QsUFVULERFTEVURSxPUFRJT05TJyxcclxuICAgIH07XHJcblxyXG4gICAgLy8gSGFuZGxlIE9QVElPTlMgcmVxdWVzdHMgZm9yIENPUlNcclxuICAgIGlmIChodHRwTWV0aG9kID09PSAnT1BUSU9OUycpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICAgICAgaGVhZGVycyxcclxuICAgICAgICBib2R5OiAnJyxcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSb3V0ZSBoYW5kbGluZ1xyXG4gICAgaWYgKHBhdGggPT09ICcvdmVudWVzJyAmJiBodHRwTWV0aG9kID09PSAnR0VUJykge1xyXG4gICAgICByZXR1cm4gYXdhaXQgbGlzdFZlbnVlcygpO1xyXG4gICAgfSBlbHNlIGlmIChwYXRoID09PSAnL3ZlbnVlcycgJiYgaHR0cE1ldGhvZCA9PT0gJ1BPU1QnKSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCBjcmVhdGVWZW51ZShib2R5KTtcclxuICAgIH0gZWxzZSBpZiAocGF0aFBhcmFtZXRlcnM/LnZlbnVlSWQgJiYgaHR0cE1ldGhvZCA9PT0gJ0dFVCcpIHtcclxuICAgICAgcmV0dXJuIGF3YWl0IGdldFZlbnVlKHBhdGhQYXJhbWV0ZXJzLnZlbnVlSWQpO1xyXG4gICAgfSBlbHNlIGlmIChwYXRoUGFyYW1ldGVycz8udmVudWVJZCAmJiBodHRwTWV0aG9kID09PSAnUFVUJykge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdXBkYXRlVmVudWUocGF0aFBhcmFtZXRlcnMudmVudWVJZCwgYm9keSk7XHJcbiAgICB9IGVsc2UgaWYgKHBhdGhQYXJhbWV0ZXJzPy52ZW51ZUlkICYmIGh0dHBNZXRob2QgPT09ICdERUxFVEUnKSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCBkZWxldGVWZW51ZShwYXRoUGFyYW1ldGVycy52ZW51ZUlkKTtcclxuICAgIH0gZWxzZSBpZiAocGF0aC5pbmNsdWRlcygnL2FuYWx5dGljcycpICYmIGh0dHBNZXRob2QgPT09ICdHRVQnKSB7XHJcbiAgICAgIGNvbnN0IHZlbnVlSWQgPSBwYXRoUGFyYW1ldGVycz8udmVudWVJZDtcclxuICAgICAgcmV0dXJuIGF3YWl0IGdldFZlbnVlQW5hbHl0aWNzKHZlbnVlSWQhKTtcclxuICAgIH0gZWxzZSBpZiAocGF0aC5pbmNsdWRlcygnL3RvdXJuYW1lbnRzJykgJiYgaHR0cE1ldGhvZCA9PT0gJ0dFVCcpIHtcclxuICAgICAgY29uc3QgdmVudWVJZCA9IHBhdGhQYXJhbWV0ZXJzPy52ZW51ZUlkO1xyXG4gICAgICByZXR1cm4gYXdhaXQgbGlzdFZlbnVlVG91cm5hbWVudHModmVudWVJZCEpO1xyXG4gICAgfSBlbHNlIGlmIChwYXRoLmluY2x1ZGVzKCcvdG91cm5hbWVudHMnKSAmJiBodHRwTWV0aG9kID09PSAnUE9TVCcpIHtcclxuICAgICAgY29uc3QgdmVudWVJZCA9IHBhdGhQYXJhbWV0ZXJzPy52ZW51ZUlkO1xyXG4gICAgICByZXR1cm4gYXdhaXQgY3JlYXRlVG91cm5hbWVudCh2ZW51ZUlkISwgYm9keSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzQ29kZTogNDA0LFxyXG4gICAgICBoZWFkZXJzLFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTm90IEZvdW5kJyB9KSxcclxuICAgIH07XHJcblxyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InIH0pLFxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcblxyXG5hc3luYyBmdW5jdGlvbiBsaXN0VmVudWVzKCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgVGFibGVOYW1lOiBWRU5VRVNfVEFCTEUsXHJcbiAgICBJbmRleE5hbWU6ICdMb2NhdGlvbkluZGV4JyxcclxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdjaXR5ID0gOmNpdHknLFxyXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAnOmNpdHknOiAnU3lkbmV5JywgLy8gRGVmYXVsdCB0byBTeWRuZXkgZm9yIG5vd1xyXG4gICAgfSxcclxuICB9KTtcclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIHZlbnVlczogcmVzdWx0Lkl0ZW1zIHx8IFtdLFxyXG4gICAgfSksXHJcbiAgfTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlVmVudWUoYm9keTogc3RyaW5nIHwgbnVsbCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgaWYgKCFib2R5KSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnIH0pLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHZlbnVlRGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XHJcbiAgY29uc3QgdmVudWVJZCA9IGB2ZW51ZV8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XHJcbiAgXHJcbiAgY29uc3QgdmVudWUgPSB7XHJcbiAgICB2ZW51ZUlkLFxyXG4gICAgdmVudWVOYW1lOiB2ZW51ZURhdGEudmVudWVOYW1lLFxyXG4gICAgYWRkcmVzczogdmVudWVEYXRhLmFkZHJlc3MsXHJcbiAgICBjaXR5OiB2ZW51ZURhdGEuY2l0eSB8fCAnU3lkbmV5JyxcclxuICAgIHN0YXRlOiB2ZW51ZURhdGEuc3RhdGUgfHwgJ05TVycsXHJcbiAgICBjb3VudHJ5OiB2ZW51ZURhdGEuY291bnRyeSB8fCAnQXVzdHJhbGlhJyxcclxuICAgIHBob25lOiB2ZW51ZURhdGEucGhvbmUsXHJcbiAgICBlbWFpbDogdmVudWVEYXRhLmVtYWlsLFxyXG4gICAgd2Vic2l0ZTogdmVudWVEYXRhLndlYnNpdGUsXHJcbiAgICBkZXNjcmlwdGlvbjogdmVudWVEYXRhLmRlc2NyaXB0aW9uLFxyXG4gICAgY2FwYWNpdHk6IHZlbnVlRGF0YS5jYXBhY2l0eSxcclxuICAgIHBvb2xUYWJsZXM6IHZlbnVlRGF0YS5wb29sVGFibGVzIHx8IDEsXHJcbiAgICBhbWVuaXRpZXM6IHZlbnVlRGF0YS5hbWVuaXRpZXMgfHwgW10sXHJcbiAgICBvcGVyYXRpbmdIb3VyczogdmVudWVEYXRhLm9wZXJhdGluZ0hvdXJzLFxyXG4gICAgb3duZXJJZDogdmVudWVEYXRhLm93bmVySWQsXHJcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgc3RhdHVzOiAnYWN0aXZlJyxcclxuICB9O1xyXG5cclxuICBjb25zdCBjb21tYW5kID0gbmV3IFB1dENvbW1hbmQoe1xyXG4gICAgVGFibGVOYW1lOiBWRU5VRVNfVEFCTEUsXHJcbiAgICBJdGVtOiB2ZW51ZSxcclxuICB9KTtcclxuXHJcbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzdGF0dXNDb2RlOiAyMDEsXHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyB2ZW51ZSB9KSxcclxuICB9O1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRWZW51ZSh2ZW51ZUlkOiBzdHJpbmcpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZCh7XHJcbiAgICBUYWJsZU5hbWU6IFZFTlVFU19UQUJMRSxcclxuICAgIEtleTogeyB2ZW51ZUlkIH0sXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICBpZiAoIXJlc3VsdC5JdGVtKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICAgIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdWZW51ZSBub3QgZm91bmQnIH0pLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzdGF0dXNDb2RlOiAyMDAsXHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXHJcbiAgICB9LFxyXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyB2ZW51ZTogcmVzdWx0Lkl0ZW0gfSksXHJcbiAgfTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlVmVudWUodmVudWVJZDogc3RyaW5nLCBib2R5OiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBpZiAoIWJvZHkpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcgfSksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdXBkYXRlRGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XHJcbiAgbGV0IHVwZGF0ZUV4cHJlc3Npb24gPSAnU0VUIHVwZGF0ZWRBdCA9IDp1cGRhdGVkQXQnO1xyXG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGFueSA9IHtcclxuICAgICc6dXBkYXRlZEF0JzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gIH07XHJcblxyXG4gIC8vIEJ1aWxkIGR5bmFtaWMgdXBkYXRlIGV4cHJlc3Npb25cclxuICBPYmplY3Qua2V5cyh1cGRhdGVEYXRhKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICBpZiAoa2V5ICE9PSAndmVudWVJZCcgJiYga2V5ICE9PSAnY3JlYXRlZEF0Jykge1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzW2A6JHtrZXl9YF0gPSB1cGRhdGVEYXRhW2tleV07XHJcbiAgICAgIHVwZGF0ZUV4cHJlc3Npb24gKz0gYCwgJHtrZXl9ID0gOiR7a2V5fWA7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XHJcbiAgICBUYWJsZU5hbWU6IFZFTlVFU19UQUJMRSxcclxuICAgIEtleTogeyB2ZW51ZUlkIH0sXHJcbiAgICBVcGRhdGVFeHByZXNzaW9uOiB1cGRhdGVFeHByZXNzaW9uLFxyXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcclxuICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnLFxyXG4gIH0pO1xyXG5cclxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHN0YXR1c0NvZGU6IDIwMCxcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgIH0sXHJcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHZlbnVlOiByZXN1bHQuQXR0cmlidXRlcyB9KSxcclxuICB9O1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBkZWxldGVWZW51ZSh2ZW51ZUlkOiBzdHJpbmcpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVsZXRlQ29tbWFuZCh7XHJcbiAgICBUYWJsZU5hbWU6IFZFTlVFU19UQUJMRSxcclxuICAgIEtleTogeyB2ZW51ZUlkIH0sXHJcbiAgfSk7XHJcblxyXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZTogMjA0LFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgfSxcclxuICAgIGJvZHk6ICcnLFxyXG4gIH07XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldFZlbnVlQW5hbHl0aWNzKHZlbnVlSWQ6IHN0cmluZyk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XHJcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgVGFibGVOYW1lOiBBTkFMWVRJQ1NfVEFCTEUsXHJcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAndmVudWVJZCA9IDp2ZW51ZUlkJyxcclxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgJzp2ZW51ZUlkJzogdmVudWVJZCxcclxuICAgIH0sXHJcbiAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gTW9zdCByZWNlbnQgZmlyc3RcclxuICAgIExpbWl0OiAzMCwgLy8gTGFzdCAzMCBkYXlzXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZTogMjAwLFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgfSxcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgYW5hbHl0aWNzOiByZXN1bHQuSXRlbXMgfHwgW10sXHJcbiAgICB9KSxcclxuICB9O1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBsaXN0VmVudWVUb3VybmFtZW50cyh2ZW51ZUlkOiBzdHJpbmcpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcclxuICAgIFRhYmxlTmFtZTogVE9VUk5BTUVOVFNfVEFCTEUsXHJcbiAgICBJbmRleE5hbWU6ICdWZW51ZVRvdXJuYW1lbnRzSW5kZXgnLFxyXG4gICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3ZlbnVlSWQgPSA6dmVudWVJZCcsXHJcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XHJcbiAgICAgICc6dmVudWVJZCc6IHZlbnVlSWQsXHJcbiAgICB9LFxyXG4gICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UsIC8vIE1vc3QgcmVjZW50IGZpcnN0XHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZTogMjAwLFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgfSxcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgdG91cm5hbWVudHM6IHJlc3VsdC5JdGVtcyB8fCBbXSxcclxuICAgIH0pLFxyXG4gIH07XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRvdXJuYW1lbnQodmVudWVJZDogc3RyaW5nLCBib2R5OiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcclxuICBpZiAoIWJvZHkpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcclxuICAgICAgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcgfSksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdG91cm5hbWVudERhdGEgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gIGNvbnN0IHRvdXJuYW1lbnRJZCA9IGB0b3VybmFtZW50XyR7RGF0ZS5ub3coKX1fJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YDtcclxuICBcclxuICBjb25zdCB0b3VybmFtZW50ID0ge1xyXG4gICAgdG91cm5hbWVudElkLFxyXG4gICAgdmVudWVJZCxcclxuICAgIHRvdXJuYW1lbnROYW1lOiB0b3VybmFtZW50RGF0YS50b3VybmFtZW50TmFtZSxcclxuICAgIGRlc2NyaXB0aW9uOiB0b3VybmFtZW50RGF0YS5kZXNjcmlwdGlvbixcclxuICAgIHN0YXJ0RGF0ZTogdG91cm5hbWVudERhdGEuc3RhcnREYXRlLFxyXG4gICAgZW5kRGF0ZTogdG91cm5hbWVudERhdGEuZW5kRGF0ZSxcclxuICAgIGVudHJ5RmVlOiB0b3VybmFtZW50RGF0YS5lbnRyeUZlZSxcclxuICAgIHByaXplUG9vbDogdG91cm5hbWVudERhdGEucHJpemVQb29sLFxyXG4gICAgbWF4UGFydGljaXBhbnRzOiB0b3VybmFtZW50RGF0YS5tYXhQYXJ0aWNpcGFudHMsXHJcbiAgICBjdXJyZW50UGFydGljaXBhbnRzOiAwLFxyXG4gICAgc3RhdHVzOiAndXBjb21pbmcnLFxyXG4gICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICB9O1xyXG5cclxuICBjb25zdCBjb21tYW5kID0gbmV3IFB1dENvbW1hbmQoe1xyXG4gICAgVGFibGVOYW1lOiBUT1VSTkFNRU5UU19UQUJMRSxcclxuICAgIEl0ZW06IHRvdXJuYW1lbnQsXHJcbiAgfSk7XHJcblxyXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhdHVzQ29kZTogMjAxLFxyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxyXG4gICAgfSxcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdG91cm5hbWVudCB9KSxcclxuICB9O1xyXG59ICJdfQ==
