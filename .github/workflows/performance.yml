name: Performance Tests
true:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
  schedule:
  - cron: 0 0 * * *
jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: npm
    - name: Install dependencies
      run: npm ci
    - name: Install Cypress
      run: npx cypress install
    - name: Run performance tests
      run: 'npx cypress run --spec "cypress/e2e/performance/**/*.cy.ts" --browser
        chrome --headless

        '
      env:
        CYPRESS_PERFORMANCE_MODE: true
        CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
    - name: Generate performance report
      run: node scripts/generate-performance-report.js
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: cypress/reports/performance
        retention-days: 90
    - name: Check performance thresholds
      run: 'node scripts/check-performance-thresholds.js

        '
      env:
        FAIL_ON_THRESHOLD_BREACH: true
    - name: Comment PR with performance results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: "const fs = require('fs');\nconst report = JSON.parse(fs.readFileSync('cypress/reports/performance/report.json',\
          \ 'utf8'));\n\nconst summary = `## Performance Test Results\n\n- Total Tests:\
          \ ${report.summary.totalTests}\n- Passed: ${report.summary.passedTests}\n\
          - Failed: ${report.summary.failedTests}\n- Average Score: ${report.summary.averageScore.toFixed(2)}%\n\
          \n${report.summary.failedTests > 0 ? '### Failed Metrics\\n\\n' + report.metrics\n\
          \  .filter(m => !m.passed)\n  .map(m => `- ${m.name}: ${m.value}${m.unit}\
          \ (Threshold: ${m.threshold}${m.unit})`)\n  .join('\\n') : ''}\n`;\n\ngithub.rest.issues.createComment({\n\
          \  issue_number: context.issue.number,\n  owner: context.repo.owner,\n \
          \ repo: context.repo.repo,\n  body: summary\n});"
